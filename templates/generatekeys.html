{% extends "layout.html" %}

{% block title %}ML Coins{% endblock %}

{% block css %}
  <link href="/static/css/index.css" rel="stylesheet">
  <link href="/static/css/keys.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row hide-on-print">
  <div class="col-md-2 col-sm-2 col-xs-4">
    <a href="http://media.mit.edu">
      <img src="/static/img/mllogo.png" class="img-responsive" alt="MIT Media Lab"/>
    </a>
  </div>
</div>
<div class="row hide-on-print">
  <div class="col-md-6 col-sm-8 col-xs-12">
    <h3 class="heading font-bold">Create your Bitcoin identity</h3>
    <p class="description font-light">
        Please turn off your wifi and continue. Once your Bitcoin keys have been generated, please print them out and save them. Then return to coins.media.mit.edu.
        <br>
        <button id="generatekeys" class="btn btn-default btn-margin">Generate Keys</button><div id="to-load"></div>
    </p>
  </div>
</div>
<div class="row">
  <div id="keys" class="col-md-6 col-sm-8 col-xs-12 divToPrint">
    <img id="logo" src="/static/img/mllogo.png" class="img-responsive" alt="MIT Media Lab" width="20px"/>
    <span class="heading font-bold"> DO NOT DISCARD<span><br><br>
    <p class="description font-light key-text wallet-warning">The Media Lab does not contain a copy of this information. </p>
    <p class="description key-text"> Bitcoin Public Address: </p>
    <p class="description font-light key-text" id="pubKey">
    </p>
    <p><center><div id="pubKeyQr"></div></center></p>
    <p id="middle-section">
    </p>
    <p class="description font-light key-text fold-text">Fold along line to hide private key.</p>
    <p class="description key-text"> Private Key: </p>
    <p class="description font-light key-text" id="privKey">
    </p>
    <p><center><div id="privKeyQr"></div></center></p>
  </div>
</div>
<div class="row hide-on-print">
  <div class="col-md-6 col-sm-8 col-xs-12">
    <button id="print-btn" class="btn btn-default btn-margin font-light">Print</button>
  </div>
</div>
<div class="row hide-on-print">
  <div class="col-md-6 col-sm-8 col-xs-12">
    <button 
    id="copy-btn" 
    class="btn btn-default btn-margin font-light" 
    data-clipboard-action="copy" 
    data-clipboard-target="#pubKey"
    data-placement="right"
    title="Copied!">
      Copy Public Address
    </button>
  </div>
</div>
<div class="row hide-on-print">
  <div class="col-md-6 col-sm-8 col-xs-12">
    <p class="description font-light">
      <br>
      <a id="return-link" href="/request"> Return to the coin's request page >> </a>
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="/static/js/register.js"></script>
<script type="text/javascript" src="/static/js/dotdotdot.js"></script>
<script type="text/javascript" src="/static/js/bitcoinjs.min.js"></script>
<script type="text/javascript" src="/static/js/qrcode.min.js"></script>
<script type="text/javascript" src="/static/js/clipboard.min.js"></script>
<script src="/static/js/print.js"></script>
<script>
  var clipboard = new Clipboard('#copy-btn');

  $('#copy-btn').tooltip({'trigger': 'click', delay: { "show": 500, "hide": 100 }});

  $("#generatekeys").click(function(){

    $("#keys").hide();
    $("#print-btn").hide();
    $("#copy-btn").hide();
    $("#return-link").hide();

    var keyPair = bitcoin.ECPair.makeRandom();
    $('#privKey').text(keyPair.toWIF());
    $('#pubKey').text(keyPair.getAddress());
    $("#pubKeyQr").html("");
    $("#privKeyQr").html("");

    var qrcode1 = new QRCode(document.getElementById("pubKeyQr"), {
      text: keyPair.getAddress(),
      width: 70,
      height: 70,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });
    var qrcode2 = new QRCode(document.getElementById("privKeyQr"), {
      text: keyPair.toWIF(),
      width: 60,
      height: 60,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });

    $("#to-load").show();
    $("#to-load").Loadingdotdotdot({
        "speed": 400,
        "maxDots": 4,
        "word": "Loading"
    });

    setTimeout(
      function() 
      {
        $("#keys").show();
        $("#print-btn").show();
        $("#copy-btn").show();
        $("#return-link").attr('href', '/request?identity=true&address='+keyPair.getAddress());
        $("#return-link").show();
        $("#to-load").Loadingdotdotdot("Stop");
        $("#to-load").hide();
      }, 5000);

  });

  clipboard.on('success', function(e) {
      console.info('Action:', e.action);
      console.info('Text:', e.text);
      console.info('Trigger:', e.trigger);
      e.clearSelection();
  });

  clipboard.on('error', function(e) {
      console.error('Action:', e.action);
      console.error('Trigger:', e.trigger);
  });
  
</script>
{% endblock %}